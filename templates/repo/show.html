{% extends "../base.html" %}

{% block stylesheets %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/highlight.js/8.6.0/styles/github.min.css">
{% end %}

{% block content %}
<div class="row">
  <div class="col-sm-10 col-sm-offset-1">
    <div class="masthead">
      <div class="repo-head">
        <h1 class="repo-title"><span class="mega-octicon {% if repo.private %}octicon-lock lock-icon{% else %}octicon-repo repo-icon{% end %}"></span> <a href="{{ reverse_url("web:user", repo.user.name) }}" class="repo-title-username">{{ repo.user.name }}</a><span class="path-divider">/</span><a href="{{ reverse_url("web:repo", repo.user.name, repo.name) }}" class="repo-title-reponame">{{ repo.name }}</a>{% if repo.private %} <span class="label label-private">Private</span>{% end %}</h1>
        <p class="text-muted">{{ repo.desc }}</p>
      </div>
    </div>
  </div>
</div>

<div class="row">
  {% set base_url = request.protocol + "://" + request.host + request.path %}
  {% set api_url = request.protocol + "://" + request.host + "/api" + request.path %}
  <div class="col-sm-10 col-sm-offset-1">
    {% if current_user == repo.user %}
    <div class="alert alert-info" role="alert">
      <h5><strong>You created this repository.</strong></h5>

      <p>Here is how to get started:</p>

      <p>
        <ol>
          <li>
            In order to track your <em>linked data</em> resources through the Push API, you will first need to generate an API token.
            You can do so <a href="{{ reverse_url("web:new-token") }}">by following this link</a>.
            Copy the generated token right away as it will only be displayed once.
          </li>
          <li>
            To authorize push access to your repository, we verify the secret token passed in the <code>Authorization</code> HTTP header of a request actually belongs to you.
            You can revoke access granted by a token by deleting it on the <a href="{{ reverse_url("web:settings") }}">settings page</a>.
          </li>
          <li>
            You can push new versions of your tracked resources through straight-forward HTTP requests.
            Specify the original URI of the resource in the <code>key</code> query parameter.
            You can supply an optional <code>datetime</code> value to say when the resource was changed or else the current server time will be used as a default.
            <ul>
              <li>A <code>PUT</code> request with the resource RDF description in the body will create a new revision of the resource.</li>
              <li>A <code>DELETE</code> request marks an existing resource as, well, deleted.</li>
            </ul>
            Acceptable <code>Content-Type</code> values are <code>application/rdf+xml</code>, <code>application/n-triples</code> and <code>text/turtle</code>.
          </li>
          <li>
            An example of how to send requests from the command-line using <code>curl</code> is given below (<a href="http://explainshell.com/explain?cmd=curl+-X+PUT+-H+%22Authorization%3A+token+%24TOKEN%22+-H+%22Content-Type%3A+application%2Fn-triples%22+--data-binary+%40path%2Fto%2Fresource.nt+%22{{ url_escape(api_url + "?key=http://...&datetime=...") }}%22" target="_blank">explanation here</a>).<br>
          </li>
        </ol>
      </p>

      <p>For more information on pushing data to a repository, please also refer to the official <a href="https://github.com/SemanticMultimedia/tlr#push-api">project readme</a>.</p>
    </div>

    <pre><code class="bash"># export the token for later use
export TOKEN="0bc283..."<br>
# create a new revision of a resource with an RDF description
curl -X PUT \
  -H "Authorization: token $TOKEN" \
  -H "Content-Type: application/n-triples" \
  --data-binary @path/to/resource.nt \
  "{{ api_url }}?key=http://...&datetime=yyyy-MM-dd-HH:mm:ss"<br>
# mark a resource as deleted
curl -X DELETE \
  -H "Authorization: token $TOKEN" \
  "{{ api_url }}?key=http://...&datetime=..."</code></pre>

    <hr>
    {% end %}

    <div class="panel panel-default">
      <div class="panel-heading">Memento API</div>
      <div class="panel-body">
        <h4>Reading resource states from {{ repo.name }}</h4>

        {% if repo.private %}<h5><strong>This is a private repository: Only you can access this repository.</strong></h5>{% end %}

        <p>Prior states of <em>linked data</em> resources tracked in this repository are accessible through a <a href="https://datatracker.ietf.org/doc/rfc7089/">Memento</a> API.</p>
        <p>
          You can request a certain resource from this repository by specifying its URI in the <code>key</code> query parameter.
          Specify the date and time for the resource state you are interested in by passing an <code>Accept-Datetime</code> HTTP header, for instance:
        </p>
        <pre><code class="bash">curl {% if repo.private %}-H "Authorization: token $TOKEN" \
  {% end %}-H "Accept-Datetime: Thu, 11 June 2015 09:45:00 GMT" \
  "{{ api_url }}?key=http://..."</code></pre>
        <p>In order to link to a certain resource state, you may also provide the datetime argument as a query parameter:</p>
        <pre><code class="bash">curl {% if repo.private %}-H "Authorization: token $TOKEN" \
  {% end %}"{{ api_url }}?key=http://...&datetime=2015-06-11-09:45:00"</code></pre>
        <p>To find out when a resource was changed, query for the timemap:</p>
        <pre><code class="bash">curl {% if repo.private %}-H "Authorization: token $TOKEN" \
  {% end %}"{{ api_url }}?key=http://...&timemap=true"</code></pre>
        {% if len(hm) > 0 %}
        <p>You can find links to a small sample of resources from this repository below:</p>
        {% else %}
        <p><small><strong>This repository is still empty.</strong></small></p>
        {% end %}
      </div>

      {% if len(hm) > 0 %}
      <ul class="list-group">
        {% for h in hm %}
            <div class="list-group-item"><a href="{{ base_url + "?key=" + h.val + "&timemap=true" }}">{{ h.val }}</a><span class="pull-right text-muted memento-infos timestamp">{{ h.time}}</span></div>
          {% end %}
        <li class="list-group-item" style="background: #F5F5F5;"><a class="btn btn-default" href="{{ base_url + "?index=true" }}">Show All</a></li>
      </ul>
      {% end %}
    </div>

    {% if current_user == repo.user %}
    <hr>

    <div class="panel panel-danger">
      <div class="panel-heading">Danger Zone</div>
      <div class="panel-body">
        <h4>Privacy</h4>
          <button data-toggle="collapse" data-target="#change_privacy_confirm" class="btn btn-danger btn-xs pull-right">Change privacy</button>
          <p>This repository is {% if repo.private %}<strong>private</strong>: Only you can access this repository{% else %}<strong>public</strong>: Anybody can access this repository{% end %}.</p>
          <div id="change_privacy_confirm" class="collapse">
          <form action="{{ reverse_url("web:edit-repo", repo.user.name, repo.name) }}" method="post">
            {% module xsrf_form_html() %}
            <div class="form-checkbox">
              <label>
                <input {% if not repo.private %}checked="checked"{% end %} class="js-privacy-toggle" id="repository-private-false" name="private" type="radio" value="false"> Public
              </label>
              <span class="mega-octicon octicon-repo repo-icon"> </span>
              <span class="help-block">Anyone can see contents of this repository. You can commit to this repository.</span>
            </div>
            <div class="form-checkbox">
              <label>
                <input {% if repo.private %}checked="checked"{% end %} class="js-privacy-toggle" id="repository-private-true" name="private" type="radio" value="true"> Private
              </label>
              <span class="mega-octicon octicon-lock lock-icon"> </span>
              <span class="help-block">Only you can see and commit to this repository.</span>
            </div>
            <div class="form-group">
              <button type="submit" class="btn btn-danger btn-block btn-primary">Update privacy of this repository</button>
            </div>
          </form>
          </div>

        <hr>
        <h4>Delete this repository</h4>
          <button data-toggle="collapse" data-target="#delete_repo_confirm" class="btn btn-danger btn-xs pull-right">Delete this repository</button>
          <p>Once you delete a repository, there is no going back. Please be certain.</p>
        <div id="delete_repo_confirm" class="collapse">
          <h3>Are you absolutely sure?</h3>
            <div class="alert alert-warning">
                Unexpected bad things will happen if you donâ€™t read this!
            </div>
            <p>This action <strong>CANNOT</strong> be undone. This will permanently delete the <strong>{{ repo.user.name }}<span class="path-divider">/</span>{{ repo.name }}</strong> repository and remove all contained data.</p>
            <p>Please type in the name of the repository to confirm.</p>
          <form action="{{ reverse_url("web:del-repo", repo.user.name, repo.name) }}" data-toggle="validator" method="post">
          {% module xsrf_form_html() %}
          <div class="form-group">
            <input type="text" class="form-control" autofocus required pattern="{{ repo.name }}" data-match-error="Type in the name of the repository (omit the user name) to confirm that you want to delete this repository." name="verify">
            <div class="help-block with-errors"></div>
          </div>
          <div class="form-group">
            <button type="submit" class="btn btn-danger btn-block btn-primary">I understand the consequences, delete this repository</button>
          </div>
          </form>
        </div>
      </div>
    </div>
    {% end %}
  </div>

</div>
{% end %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/momentjs/2.10.3/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/highlight.js/8.6.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/highlight.js/8.6.0/languages/bash.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
  var timestamps = document.getElementsByClassName("timestamp");
  [].map.call(timestamps, function (ts) {
    mmt = moment(ts.innerHTML)
    ts.innerHTML = mmt.fromNow();
  });
</script>
{% end %}
